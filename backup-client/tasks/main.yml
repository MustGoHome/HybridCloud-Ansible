---
- name: 'Install packages'
  ansible.builtin.yum:
    name: epel-release
    state: present

- name: 'Install packages'
  ansible.builtin.yum:
    name: "{{ borg_packages }}"
    state: present

- name: 'Add backup user'
  ansible.builtin.user:
    name: "{{ borg_user }}"
    groups: wheel
    password: "{{ user_password | password_hash('sha512')}}"
    state: present

- name: 'Ensure .ssh directory exists for borg user'
  ansible.builtin.file:
    path: "/home/{{ borg_user }}/.ssh/"
    state: directory
    owner: "{{ borg_user }}"
    group: "{{ borg_user }}"
    mode: "0700"

- name: 'Create ssh key'
  ansible.builtin.openssh_keypair:
    path: "/home/{{ borg_user }}/.ssh/id_rsa"
    type: rsa
    size: 2048
    state: present
    mode: "0644"

- name: 'Deploy ssh public key'
  ansible.builtin.shell:
    cmd: "sshpass -p {{ user_password }} ssh-copy-id -i /home/{{ borg_user }}/.ssh/id_rsa.pub -o StrictHostKeyChecking=no {{ borg_user }}@{{ backup_server }}"

- name: 'Create backup directory'
  ansible.builtin.file:
    path: "{{ backup_dir }}/{{ ansible_facts.hostname }}"
    state: directory
    owner: "{{ borg_user }}"
    group: "{{ borg_user }}"
    mode: "0644"
    recurse: yes

# - name: 'Initialize backup directory'
#   ansible.builtin.expect:
#     command: "ssh -i /home/{{ borg_user }}/.ssh/id_rsa -o StrictHostKeyChecking=no {{ borg_user }}@{{ backup_server }} borg init --encryption=repokey {{ backup_dir }}/{{ ansible_facts.hostname }}"
#     responses:
#       'Enter new passphrase': "{{ borg_passphrase }}"
#       'Enter same passphrase again': "{{ borg_passphrase }}"
#       'Do you want your passphrase to be displayed for verification?': 'y'
#   timeout: 2
#   become_user: "{{ borg_user }}"
