# {{ ansible_managed }}
# Prometheus Server main configuration file

global:
  scrape_interval: 15s

scrape_configs:
  # Prometheus 자체 모니터링
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:{{ prometheus_web_port }}"]

  # Node Exporter 모니터링
  - job_name: "node_exporter"
    static_configs:
      - targets: ["localhost:9100"]

  # Blackbox Exporter를 사용한 ICMP 핑 체크 작업
  - job_name: "blackbox_icmp"
    metrics_path: /probe
    params:
      module: [icmp]
    
    # File Service Discovery (File SD) 설정
    file_sd_configs:
      - files:
          - "{{ prometheus_targets_dir }}/icmp_targets.json" # 변수 활용
        refresh_interval: 10s

    # Relabeling 규칙 (File SD 타겟을 Blackbox Exporter로 라우팅)
    relabel_configs:
      # 1. File SD에서 가져온 IP에 포트가 없으면 임시 포트(:80)를 붙여 유효한 타겟으로 만듦 (Port Appending)
      - source_labels: [__address__]
        target_label: __address__
        separator: ;
        regex: '([^:]+)'
        replacement: '$1:80'
        action: replace

      # 2. 임시 포트가 붙은 __address__를 __param_target (실제 핑 칠 IP)에 복사
      - source_labels: [__address__]
        target_label: __param_target
        regex: '([^:]+).*'
        replacement: '$1'

      # 3. name 라벨을 최종 instance 라벨에 복사
      - source_labels: [name]
        target_label: instance

      # 4. 최종 __address__를 Blackbox Exporter 주소로 덮어쓰기
      - target_label: __address__
        replacement: "{{ prometheus_blackbox_exporter_address }}" # 변수 활용
